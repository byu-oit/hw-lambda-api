version: "0.2"
artifacts:
  files:
  - "./terraform-iac/**/*"
  - "*.tfvars"
  - "./tst/codedeploy-hooks/after-allow-test-traffic/lambda.zip"
cache:
  paths:
    - "/root/cache/**/*"
env:
  variables: {}
phases:
  build:
    commands:
    # build app
    - "cd src"
    - "npm install"
    - zip -r lambda.zip * .*
    - "cd .."
    # build test lambda
    - "cd tst/codedeploy-hooks/after-allow-test-traffic"
    - "npm install"
    - "cp -R ../../../.postman ."
    - "zip -r lambda.zip * .*"
    - "cd ../../.."
    # pass vars to terraform deploy stage
    # TODO: maybe this is where we look up the lambda's CurrentVersion to pass in to the appspec
    # - "echo \"image_tag = \\\"$ECR_TAG_NAME\\\"\" > terraform.tfvars"
  install:
    commands: []
    runtime-versions:
      docker: "18"